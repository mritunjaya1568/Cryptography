import random
from randcrack import RandCrack
from Crypto.Util.number import *

modulus = pow(2, 32)
sbox = [[1929383878, 3639414352, 2377058152, 2997292380, 1153159998, 263604150, 2649260073, 991653744, 2144895663, 317739698, 3761404339, 313262402, 3783089312, 3231232267, 818556183, 1057852638, 2401130490, 2127738850, 536171863, 114602779, 3858160468, 857227172, 1341305904, 3405950444, 3040002421, 2166463783, 2313786097, 2732530170, 4042019737, 12985627, 3536269522, 676274297, 2481251041, 120934813, 3726112260, 2405327986, 656108309, 2176417232, 670851540, 41015719, 777961232, 3348215179, 3628320304, 478477205, 625511823, 2397110989, 1141019407, 1329262041, 2719668416, 1345121423, 2520846631, 668567003, 978652080, 3899073962, 2910146445, 2998266465, 1914553918, 1762548713, 2173468862, 3734332962, 3236555567, 3364489221, 3029987951, 790468885, 4044244629, 1112937956, 2614306972, 2466224324, 2869000644, 1046731743, 3278559252, 4265949148, 2059312955, 3111963509, 3967499045, 2478660065, 196456377, 1403234642, 1411414788, 749660430, 547373078, 3547773666, 1901121493, 1655076964, 1131434142, 978459583, 3747262675, 2906933432, 1071356392, 660246493, 2289164039, 3813238685, 2513506873, 3883446281, 860600320, 4206225609, 589222445, 964756585, 2122596874, 4045036802, 3329334097, 3450443046, 41149226, 1308783528, 3413872958, 3161775377, 573489739, 473774091, 4128904834, 4108698524, 2558453804, 773703548, 3441548046, 1785913441, 769134650, 2257259149, 2220218297, 2648246784, 3019326133, 3916283449, 1815700232, 2093076235, 2618494918, 1618953321, 4011321792, 775647135, 66180972, 1862945611, 1203641817, 2594984919, 1739323660, 1829178315, 613965636, 4265382445, 1544134558, 3811302860, 269991790, 2650393336, 3978347160, 3811101460, 3502514396, 2572388967, 842525470, 3012020514, 2560401539, 390836273, 1639637738, 870965723, 3228947449, 496112155, 3775371983, 1066934452, 456820514, 1428720131, 1035586594, 3162567683, 4013029377, 3721399101, 2453518189, 473126834, 642347158, 1493481447, 2186158974, 2580116925, 3837865577, 2050568039, 1365170230, 2866551292, 3411403082, 1861482636, 2979471821, 813451990, 3766015179, 3635566817, 3446347060, 2806659470, 245231552, 2112415818, 3380707011, 3602898878, 3621262538, 1360224276, 2578943535, 50372962, 1555650542, 1187274142, 3514859045, 660845013, 296116368, 1916426645, 2747066358, 947311983, 1819229917, 4137311746, 2396999706, 2310973201, 3791833588, 2967737573, 2660617420, 90208630, 148998535, 615973311, 1828089689, 153015978, 1225382328, 2627185132, 85788071, 2232941632, 3467182754, 2049380273, 54282808, 744295176, 1751622955, 1126529784, 2663982510, 3266430053, 115887339, 1972567939, 2063819396, 872601893, 1313593639, 290485234, 4212402756, 1166442119, 3975184281, 1578774739, 4029879517, 3747712181, 1011597248, 3760510342, 814300298, 314246327, 2798997854, 2612932482, 2664765191, 2885824913, 656142725, 1259379101, 3085160089, 2311626986, 94373276, 2619544308, 1201083713, 3896337000, 3620391298, 1109962918, 3909603080, 3673911950, 811097181, 1929060419, 3147925720, 1927803963, 1435932096, 1313435249, 3197947045, 4054566862], [2017736014, 2915215833, 2276071165, 3772175914, 2248435749, 3705224209, 3254049953, 3426114315, 2661555546, 4164740002, 3512065097, 878936702, 3300292209, 1504024630, 3576986405, 533877595, 1280773204, 2506235881, 232687245, 3910366280, 1968822284, 324259542, 3766477370, 2536056432, 3570275296, 1592769711, 769740066, 698465618, 1355296115, 1854005546, 3765686623, 1905543777, 440974237, 1870810139, 56165511, 4061044799, 3566401665, 1607692657, 3355444962, 2385976923, 2047494618, 3806320527, 3811502001, 3480496756, 1327047987, 319775386, 671037941, 2450310990, 3929330417, 3699991432, 1138324295, 3695031664, 1908406363, 3992163088, 2646915386, 3685663867, 210860225, 2607731073, 2541974026, 1137831776, 204700742, 3386670958, 2894129053, 2284482609, 446179172, 1047293796, 1744316987, 4215609237, 341751286, 917740696, 4071443313, 4280163833, 2283872305, 1592184085, 3613541576, 3345289951, 1138359043, 3731718471, 625738735, 171532295, 4078456086, 3896779940, 2643759913, 2888274500, 364807377, 3035135239, 2050264909, 3886194317, 1717457028, 562273050, 2841765079, 253029850, 492997235, 3595247553, 3006149285, 2276831122, 3094166058, 1872651531, 2718229157, 251808440, 690538552, 4198438931, 859318420, 2269111765, 900932105, 3487662370, 4283359869, 3080483541, 3829905582, 2970497992, 2485155905, 2415574636, 933810552, 2140125343, 2072670063, 327225389, 469444678, 2724647282, 1546412918, 518420607, 2003643977, 2341421063, 471426631, 492204, 2699773774, 1014588136, 2424573825, 2046685261, 3555825027, 2317612537, 2039931161, 1364689950, 463643228, 3855629796, 487463367, 1083433092, 2886049027, 2468965950, 3677686351, 3854251812, 4195476592, 3652843269, 2212434975, 565480660, 3771120002, 3150094749, 853744183, 2601176905, 1874226904, 4138045263, 3421662263, 531193050, 264474688, 2565781888, 3679078305, 4250298790, 3389540998, 2958664603, 2553378856, 3283312947, 2417746078, 124777158, 240506312, 957535775, 2912867939, 818849187, 2530804987, 3197409168, 2638863302, 2661820741, 523471819, 2803660918, 2244988368, 2477912216, 291201929, 2018342486, 3711295000, 2883119763, 1258424005, 896027307, 3614178098, 3525419420, 212883777, 1467390397, 1548787489, 3716132277, 4009431309, 75623729, 2591931985, 3271411208, 3902734186, 3426076565, 4113865148, 3450987011, 357569199, 1108153632, 2964559750, 4239456510, 3360585978, 1531934440, 1610362377, 797537681, 3173311597, 1844656264, 3540778013, 3181370671, 2678209969, 558754747, 88140498, 3788372203, 4025936722, 1026583111, 3252795764, 250521735, 2495355207, 1029072103, 1670020260, 2930286662, 3986889704, 3529823494, 2461412009, 3047045754, 4294807796, 2036835752, 1986083971, 1083128113, 3540248493, 3459892921, 1224341030, 1432927248, 3167271021, 2554065601, 3290253619, 3216416542, 3550358461, 1255945350, 7654093, 3567295538, 2820973189, 3670161116, 2436520412, 2643626984, 1812654893, 2323612125, 381591575, 3129487218, 981428516, 3776292990, 1368529719, 878315653, 2162217677, 1877722971, 4064337663, 3788235461, 1081348261, 1439339992], [4007720771, 59321316, 2827247119, 4008208732, 128357587, 3970695740, 1318101605, 1625903390, 484172130, 1869827592, 2134907935, 3418676719, 2013464393, 2932659877, 1410322313, 3254402412, 511907074, 2589488022, 3161499525, 1428897159, 4067060186, 3192970172, 3433167322, 3491024631, 1267218721, 3445454791, 1829684504, 401183037, 3973548196, 2273571848, 3149532203, 2009087097, 4271605661, 153977510, 2983385502, 799072312, 1811032526, 175746, 1081029047, 2392160480, 3815451227, 1072234487, 3228886050, 2109929556, 403126065, 1427110850, 925569837, 3497808385, 2697892747, 2488179513, 1851679111, 4269204253, 707617668, 2288949645, 3266126212, 1082982839, 3052588833, 394704305, 645903025, 640533444, 2630282754, 3619951908, 2767022836, 1370789223, 450820110, 2123643359, 2394571285, 2178317030, 1748829270, 890953201, 3159927869, 2157243341, 4049893325, 2169192437, 3147802226, 3387981972, 1427174968, 3536984521, 2395303540, 2066018713, 1142515188, 2839761729, 3367403677, 2099027920, 627198404, 212749185, 3233614759, 593655165, 3140610258, 65217447, 3275674994, 1597347035, 3665125252, 2595713092, 2782912054, 2507878073, 1946110984, 1526157418, 3389409453, 3522681012, 2010861558, 2792232950, 1945929700, 1081115252, 3056324348, 4164004069, 2030976171, 1290899743, 796740375, 1147036481, 2415319111, 3856182145, 403355349, 809983857, 3444210257, 371679538, 2621598681, 2288194558, 3539326244, 2431893164, 3323165868, 3658876241, 1859590705, 2543307939, 3808713701, 4290131788, 2087860328, 798863860, 484428049, 1201917465, 2290615082, 742954718, 3098254342, 137754294, 3266263855, 3953761714, 271387372, 570041599, 459953929, 3888271228, 1520211732, 2843745430, 653383096, 815682241, 221735697, 1539887533, 4106545839, 3394010735, 3479384290, 791270995, 1822493133, 1930583270, 3222244265, 381057689, 389798644, 4251858185, 2853854614, 1939637210, 2096867812, 528610957, 585147213, 2470749006, 3044926424, 1527208418, 2674144687, 3570312352, 701040894, 2990318448, 2453700190, 1552750820, 1467260133, 640708089, 68635557, 1531068944, 532548795, 2841897580, 1629525240, 214533727, 1130087562, 584125364, 4095551100, 3860298116, 2711498051, 4155786338, 1086280783, 1901956322, 2001493039, 2128620829, 967260120, 1698159234, 587555909, 2821118171, 927311194, 1339703348, 3364727028, 622251446, 2826330458, 2384450088, 1345609159, 3127300423, 2503339970, 3925992155, 3141792049, 4260146601, 3847067787, 1223156618, 4005556140, 439458217, 3362930242, 143342066, 3503707643, 4060710198, 4234629555, 3589691657, 3069097709, 396036526, 2417789080, 1709321123, 2107606167, 2072744058, 1379133197, 1889955916, 2300891420, 3207920968, 1181068048, 2929424312, 4199826024, 4106953631, 2049638071, 1961741873, 3114890100, 1384049007, 2443237794, 3512934776, 3691105695, 1114565572, 1584726344, 179605162, 3120163172, 2810506874, 1401917003, 1568985425, 3742779227, 3533641140, 3642514710, 107702349, 441425245, 1604052947, 1903733372, 3678401749, 1012542658, 2438777323, 1654485927, 2613137314, 2885295128, 253169487], [3564746638, 3336851262, 4253635954, 698890915, 1387148912, 1662503073, 4021634653, 560060373, 3333202125, 2776807530, 2780264313, 3119156317, 965018945, 3433399086, 2326369560, 640730430, 943918219, 1681558038, 3749084333, 733630138, 511342848, 4039953690, 1530962741, 2236428570, 1832699912, 3923559820, 941423102, 3503928641, 1173574211, 731180597, 1352275470, 1340282168, 3147558114, 3183482727, 1716341201, 4104145734, 1182898674, 4162080342, 3297871535, 3000399813, 799801794, 1234404653, 3070873125, 4245379818, 4077760608, 3681009024, 1060473884, 2228625706, 4289306380, 2374781817, 2501301546, 3350028451, 2324801426, 886977139, 3086981375, 3244161236, 2282474081, 2378755713, 2910070222, 2985521951, 4004846239, 3793203713, 2870289937, 1344382357, 3240141373, 1353256601, 386444266, 1026215076, 3882608213, 788013269, 3015125504, 2738814318, 2591977537, 3815889324, 809961570, 1184438986, 3371759236, 330050563, 3369729638, 4054024955, 2974936481, 3671496814, 12903289, 2163964928, 3617162440, 1890136116, 3832622242, 1515388648, 674186779, 316887544, 3989536163, 3295981780, 295700048, 394694037, 3530012819, 1199478984, 4169991221, 4137641160, 3251117970, 4068774079, 731810816, 1950114730, 1027533266, 3989803450, 1911516158, 3613122890, 1955052529, 695160238, 832882393, 4216610311, 2963066489, 729169480, 3329661750, 4117121631, 830854401, 672542603, 2120278493, 1034833618, 1243332272, 3972066554, 3400736234, 2402598950, 2529229729, 1489099572, 1897107871, 1479287628, 1507977972, 1211387828, 2995495559, 1421909399, 84706145, 263179130, 3676263641, 964612547, 494432361, 1316016906, 1193152734, 250766292, 159390338, 832696079, 2710043235, 2084095774, 1307270413, 266314585, 2205614880, 34520511, 2180743956, 1382900464, 3306083173, 1303654537, 289270820, 1921808500, 952563116, 3546863498, 1965826128, 3005148829, 1455544096, 3336846729, 369039228, 2736631041, 1921288434, 105530823, 4073908176, 3492242328, 729846804, 3817474201, 3117572742, 2979682010, 2613783865, 1284136148, 3625879130, 459929145, 3581311619, 1468232790, 2527225838, 3773181129, 3140691849, 1140676887, 328228451, 3209344757, 3044512535, 897283764, 55289337, 66328130, 3515992335, 190066754, 4093064703, 2196186268, 2294939271, 311517763, 4054254581, 923035617, 1185644501, 3318188290, 2392087750, 2163237539, 1977762872, 2194256358, 456976345, 3612623080, 3485496775, 4181886409, 2392558745, 326894089, 1427076291, 818558291, 3435344528, 3546252378, 986744005, 1146580820, 638346221, 1500508490, 3266942361, 2277922754, 1174197985, 542543286, 2765073673, 3971773183, 2325505218, 2634139956, 214784869, 2285920032, 2346725444, 974073674, 2192295750, 2139508865, 2650190033, 2913322988, 3792527921, 1024309092, 2863104330, 3261394699, 434539302, 1764651602, 871045985, 894334607, 1984860843, 2479818551, 1331841638, 554216989, 3381117143, 4283072407, 3496149071, 2543357294, 2431553899, 1094874466, 971788086, 3340276953, 4135539916, 1822429196, 1137001044, 1530598899, 1124049528, 3141761885, 1343216488, 1791721693]]

sbox = [val for lest in sbox for val in lest]

assert len(sbox) == 1024

rc = RandCrack()
for i in range(624):
    rc.submit(sbox[i])

for i in range(400):
	assert rc.predict_getrandbits(32) == sbox[624 + i]

initial_sub_keys = ["243f6a88","85a308d3","13198a2e","03707344","a4093822","299f31d0","082efa98","ec4e6c89","452821e6","38d01377","be5466cf","34e90c6c","c0ac29b7","c97c50dd","3f84d5b5","b5470917","9216d5d9","8979fb1b"]

key = "".join([hex(rc.predict_getrandbits(32))[2:].zfill(8) for i in range(18)])

processed_sub_keys = [hex(int(initial_sub_keys[i], 16) ^ int(key[8 * i : 8 * (i + 1)], 16))[2:].zfill(8) for i in range(len(initial_sub_keys))]

ct = 'f2b4b9be3b93cb2d8cc762bdf1d6cd57419d5c83d86c31faf9d2a39a829da4f7a831790ec17c1e7d0c7ae6615b6f5343478ccd9424a77e8aa66ef09233b0caee'
pt = ""

for i in range(len(ct)//16):
    xl = ct[16 * i : 16 * i + 8]
    xr = ct[16 * i + 8 : 16 * i + 16]
    # reversing the last step with psk 16, 17
    xl , xr = hex(int(xr, 16) ^ int(processed_sub_keys[16],16))[2:].zfill(8) , hex(int(xl, 16) ^ int(processed_sub_keys[17],16))[2:].zfill(8)

    for j in range(16):
        val1,val2 = xl,xr

        xl = bin(int(val2, 16) ^ int(processed_sub_keys[15-j], 16))[2:].zfill(32)
        xa = int(xl[:8], 2)
        xb = int(xl[8:16], 2)
        xc = int(xl[16:24], 2)
        xd = int(xl[24:32], 2)
        xa = (sbox[xa] + sbox[256 + xb]) % modulus
        xc = sbox[512 + xc] ^ xa
        f_out = (xc + sbox[768 + xd]) % modulus

        xr = hex(int(val1, 16) ^ f_out)[2:].zfill(8)
        xl = val2

    pt += xl + xr

print(long_to_bytes(int(pt,16)))


# flag - b"flag{d0n't_u53_th3_m3r53nn3_r4nd0m_g3n3r4t0r_w1th0ut_c4ut10n_<3}"